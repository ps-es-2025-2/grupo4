# Diagramas de Processos de Neg√≥cio (BPM)

## Sum√°rio

- [Diagramas de Processos de Neg√≥cio (BPM)](#diagramas-de-processos-de-neg√≥cio-bpm)
  - [Sum√°rio](#sum√°rio)
  - [Notas T√©cnicas - Corre√ß√µes de Discrep√¢ncias](#notas-t√©cnicas---corre√ß√µes-de-discrep√¢ncias)
  - [1. Diagrama: M√≥dulo de Agendamento](#1-diagrama-m√≥dulo-de-agendamento)
    - [UC02: Agendar Consulta](#uc02-agendar-consulta)
    - [UC03: Solicitar Encaixe (A exce√ß√£o)](#uc03-solicitar-encaixe-a-exce√ß√£o)
    - [UC04: Registrar Bloqueio de Agenda (Gest√£o)](#uc04-registrar-bloqueio-de-agenda-gest√£o)
  - [2. Diagrama: M√≥dulo de Estoque)](#2-diagrama-m√≥dulo-de-estoque)
    - [UC05: Dar Baixa em Insumos (Consumo)](#uc05-dar-baixa-em-insumos-consumo)
    - [UC06: Processar Entrada de NF (Abastecimento)](#uc06-processar-entrada-de-nf-abastecimento)
    - [UC07: Gerar Alerta de Estoque Cr√≠tico (Monitoramento)](#uc07-gerar-alerta-de-estoque-cr√≠tico-monitoramento)
    - [UC10: Controlar Validade (Limpeza)](#uc10-controlar-validade-limpeza)
  - [3. Diagrama: Cadastro e Consulta](#3-diagrama-cadastro-e-consulta)

---

## Notas T√©cnicas - Corre√ß√µes de Discrep√¢ncias

Os diagramas BPM foram atualizados para refletir discrep√¢ncias identificadas na implementa√ß√£o.

### Discrep√¢ncia 5.1: UC07 - Gerar Alerta de Estoque Cr√≠tico

**Discrep√¢ncia:** UC07 documentado como processo completo, mas n√£o implementado (0% funcional).

**Mudan√ßa Feita:** Processo marcado como `[N√ÉO IMPLEMENTADO]` com nota explicativa.

**Justificativa:** Publisher existe, subscriber n√£o existe no m√≥dulo Estoque.

**Documento Detalhado:** [üìÑ CORRECAO_DISCREPANCIA_5.1.md](../../Corre√ß√µes%20de%20Alinhamento/CORRECAO_DISCREPANCIA_5.1.md)

### Discrep√¢ncia 5.2: UC08 - Consultar Hist√≥rico do Paciente

**Discrep√¢ncia:** UC08 documentado com integra√ß√£o de 5 m√≥dulos, mas apenas 3 funcionam (60%).

**Mudan√ßa Feita:** Processo marcado como `[IMPLEMENTA√á√ÉO PARCIAL]` com nota sobre subscribers.

**Justificativa:** Responde consultas/exames/procedimentos, n√£o responde estoque/pagamentos.

**Documento Detalhado:** [üìÑ CORRECAO_DISCREPANCIA_5.2.md](../../Corre√ß√µes%20de%20Alinhamento/CORRECAO_DISCREPANCIA_5.2.md)

### Discrep√¢ncia 5.3: UC10 - Controlar Validade de Itens

**Discrep√¢ncia:** UC10 documentado com persist√™ncia de descartes, mas apenas logs no console (50% funcional).

**Mudan√ßa Feita:** Processo marcado como `[IMPLEMENTA√á√ÉO PARCIAL]` com nota de persist√™ncia.

**Justificativa:** Busca de validade funciona, mas descarte n√£o persiste movimenta√ß√µes em BD.

**Documento Detalhado:** [üìÑ CORRECAO_DISCREPANCIA_5.3.md](../../Corre√ß√µes%20de%20Alinhamento/CORRECAO_DISCREPANCIA_5.3.md)

---

Para consultar todas as corre√ß√µes, acesse o [üìë Sum√°rio de Corre√ß√µes](../../Corre√ß√µes%20de%20Alinhamento/SUMARIO_CORRECAO_DISCREPANCIA.md).

---

## 1. Diagrama: M√≥dulo de Agendamento

Este diagrama √© uma Colabora√ß√£o que foca na gest√£o temporal da cl√≠nica. Ele orquestra como hor√°rios s√£o ocupados, for√ßados (encaixes), bloqueados ou liberados.

### UC02: Agendar Consulta

- Participantes (Raias): A Secret√°ria inicia a a√ß√£o e o Sistema processa
  as regras.

- Fluxo:

  1. In√≠cio: O processo come√ßa com a \"Necessidade de Consulta\".

  2. Verifica√ß√£o: A Secret√°ria seleciona m√©dico e data. O Sistema
      executa uma *Service Task* (tarefa autom√°tica) para consultar o
      banco de dados e verificar disponibilidade.

  3. Decis√£o (Gateway Exclusivo):

      - Caminho \"Sim\": Se livre, o fluxo segue para selecionar o
        paciente e persistir (salvar) o agendamento.

      - Caminho \"N√£o\": Se ocupado, o fluxo termina em um *End Event*
        de falha. *Nota: No mundo real, isso gatilharia o UC03.*

### UC03: Solicitar Encaixe (A exce√ß√£o)

- Cen√°rio: Este processo √© acionado quando o UC02 falha (hor√°rio
  indispon√≠vel).

- Regra de Neg√≥cio Cr√≠tica: O sistema verifica se o usu√°rio logado tem a
  permiss√£o temPermissaoEncaixe().

- Fluxo:

  1. O usu√°rio preenche a justificativa (obrigat√≥ria conforme
      RN-ENCAIXE.1 ).

  2. Gateway de Permiss√£o:

      - Se autorizado: O sistema salva o agendamento marcando a flag
        isEncaixe = true.

      - Se negado: O processo morre em um evento de fim \"Encaixe
        Negado\".

### UC04: Registrar Bloqueio de Agenda (Gest√£o)

- Objetivo: Impedir agendamentos em per√≠odos de f√©rias ou congressos.

- Valida√ß√£o: Antes de salvar o bloqueio, o Sistema verifica se j√°
  existem consultas marcadas naquele intervalo. Se houver conflito
  (Gateway \"Conflito?\"), o sistema rejeita o bloqueio e exige que o
  usu√°rio cancele as consultas primeiro.

UC09: Cancelar Agendamento

- Complexidade: Verifica a anteced√™ncia do cancelamento.

- Gateway \"Cancelamento Tarde?\": Se o cancelamento for muito em cima
  da hora, o sistema aplica uma penalidade ou loga o incidente antes de
  liberar o hor√°rio. Em ambos os casos, o status final √© atualizado para
  \"Cancelado\".

![Diagrama BPM](images/image2.png)

## 2. Diagrama: M√≥dulo de Estoque)

Este diagrama gerencia o ciclo de vida dos materiais, desde a entrada
(compra), uso (baixa) at√© o descarte e reposi√ß√£o.

### UC05: Dar Baixa em Insumos (Consumo)

- Atores: O Profissional de Sa√∫de solicita o material e o Sistema
  valida.

- Regras de Neg√≥cio (Gateways):

  1. Estoque Suficiente? Verifica se a quantidade solicitada existe.

  2. Validade OK? O sistema aplica a regra FIFO/FEFO (First-Expired,
      First-Out). Se o lote selecionado estiver vencido, a baixa √©
      bloqueada.

- Integra√ß√£o (Call Activity): Ap√≥s atualizar o saldo, o processo chama
  automaticamente o UC07 para verificar se o estoque ficou cr√≠tico.

### UC06: Processar Entrada de NF (Abastecimento)

- Ator: Gestor.

- Valida√ß√µes:

  1. Unicidade da NF: O sistema impede a entrada de uma Nota Fiscal
      duplicada.

  2. Validade Curta: Se o item comprado vencer em menos de 30 dias, o
      sistema pode emitir um alerta, mas permite a entrada (caminho de
      exce√ß√£o tratado).

### UC07: Gerar Alerta de Estoque Cr√≠tico (Monitoramento) **[REDU√á√ÉO DE ESCOPO - N√ÉO IMPLEMENTADO]**

‚ö†Ô∏è **REDU√á√ÉO DE ESCOPO**: Este processo N√ÉO est√° implementado. O m√≥dulo Estoque n√£o possui subscriber Redis para processar solicita√ß√µes de alertas autom√°ticos.

- Natureza: √â um processo de sistema (automatizado), geralmente
  disparado por um *Timer* (tempo) ou *Signal* (ap√≥s baixa/entrada).

- L√≥gica: O sistema itera sobre os itens. Se Quantidade Total \< Ponto
  Reposi√ß√£o , ele envia uma notifica√ß√£o ao Gestor.

**Implementa√ß√£o Atual**: Apenas verifica√ß√£o b√°sica `verificarEstoqueCritico(itemId)` retorna booleano, mas sem gera√ß√£o autom√°tica de alertas ou notifica√ß√µes.

### UC10: Controlar Validade (Limpeza) **[REDU√á√ÉO DE ESCOPO - IMPLEMENTA√á√ÉO PARCIAL]**

> **Status de Implementa√ß√£o**: UC10 est√° **parcialmente implementado**. A busca de itens por validade funciona via endpoint REST. Por√©m, a baixa por descarte **n√£o √© persistida em banco de dados** (apenas logs no console). N√£o h√° integra√ß√£o com M√≥dulo Financeiro.

- Fluxo: O Gestor define um crit√©rio (ex: "vence em 30 dias"). O
  sistema busca esses itens.

- A√ß√£o: O Gestor seleciona os itens para descarte. O sistema realiza uma
  baixa especial do tipo "Descarte", reduzindo o saldo cont√°bil e
  f√≠sico.

![Diagrama BPM](images/image1.png)

## 3. Diagrama: Cadastro e Consulta

Focado na integridade dos dados e na seguran√ßa da informa√ß√£o
(privacidade do paciente).

UC01: Cadastrar Novo Paciente

- Ator: Secret√°ria.

- Gateway Cr√≠tico \"CPF √önico?\": Antes de salvar, o sistema valida se o
  CPF j√° existe na base PacienteRepository. Se existir, ocorre um *Error End
  Event* (Erro de Neg√≥cio).

- Caminho Opcional: Um Gateway verifica se o paciente possui conv√™nio.
  Se \"Sim\", habilita a tarefa de \"Associar Conv√™nio\". Se \"N√£o\",
  salva apenas os dados particulares.

UC08: Consultar Hist√≥rico **[IMPLEMENTA√á√ÉO PARCIAL]**

‚ö†Ô∏è **IMPLEMENTA√á√ÉO PARCIAL**: O sistema retorna apenas dados do m√≥dulo Agendamento. M√≥dulos Estoque e Financeiro n√£o implementaram subscribers Redis.

- Seguran√ßa (Gateway de Acesso): Este √© o ponto mais importante.

  - O sistema verifica o Perfil do Usu√°rio logado.

  - Caminho M√©dico: O sistema exibe dados completos (Dados Cl√≠nicos +
    Administrativos).

  - Caminho Secret√°ria: O sistema exibe apenas dados restritos
    (Agendamentos + Administrativos), protegendo o sigilo m√©dico.

![Diagrama BPM](images/image3.png)
