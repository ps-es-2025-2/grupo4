# 3.10. Modelagem de Estados

Este documento descreve o comportamento dinâmico de 5 objetos essenciais do sistema SimpleHealth, cobrindo os módulos de Cadastro, Agendamento e Estoque através de Diagramas de Transição de Estados (DTE).

## Sumário

- [1. Descrição dos Objetos e Estados](#1-descrição-dos-objetos-e-estados)
  - [A. Módulo Cadastro: Objeto Paciente](#a-módulo-cadastro-objeto-paciente)
  - [B. Módulo Agendamento: Objeto Agendamento](#b-módulo-agendamento-objeto-agendamento)
  - [C. Módulo Estoque: Objeto Item](#c-módulo-estoque-objeto-item)
  - [D. Módulo Estoque: Objeto Pedido](#d-módulo-estoque-objeto-pedido)
  - [E. Módulo Agendamento: Objeto BlocoAgenda](#e-módulo-agendamento-objeto-blocoagenda)
- [2. Diagramas de Transição de Estados (DTE)](#2-diagramas-de-transição-de-estados-dte)
  - [DTE 1: Objeto Agendamento](#dte-1-objeto-agendamento)
  - [DTE 2: Objeto Item (Estoque)](#dte-2-objeto-item-estoque)
  - [DTE 3: Objeto Paciente](#dte-3-objeto-paciente)
  - [DTE 4: Objeto Pedido](#dte-4-objeto-pedido)
  - [DTE 5: Objeto BlocoAgenda](#dte-5-objeto-blocoagenda)

---

## 1. Descrição dos Objetos e Estados

### A. Módulo Cadastro: Objeto Paciente

Embora o diagrama de classes mostre o Paciente como uma entidade de dados estática, o Caso de Uso UC01 (Cadastrar Novo Paciente) define um fluxo de validação rigoroso. O objeto passa por um estágio transitório de validação antes de se tornar persistente no sistema.

#### Estados Identificados:

- **Em Validação**: O sistema verifica a formatação e unicidade do CPF
- **Ativo**: O paciente foi validado, gravado e está apto para agendamentos
- **Recusado/Erro**: O CPF já existe ou é inválido, impedindo a persistência

---

### B. Módulo Agendamento: Objeto Agendamento

Este é o objeto com o ciclo de vida mais complexo, envolvendo interações entre Paciente, Médico e Gestor. As transições dependem de disponibilidade, permissões (encaixe) e execução do serviço, conforme UC02, UC03 e UC09.

#### Estados Identificados:

- **Solicitado**: Estado inicial onde se verifica a disponibilidade na agenda
- **Agendado (Confirmado)**: O horário foi reservado com sucesso e o status na agenda do médico é "Ocupado"
- **Pendente de Aprovação (Encaixe)**: Ocorre quando há conflito de agenda, mas o usuário solicita um "Encaixe" (UC03), dependendo de permissão
- **Cancelado**: O agendamento foi revogado antes da execução. Pode ocorrer dentro ou fora do prazo (gerando penalidade/multa)
- **Realizado**: A consulta ocorreu e o sistema deu baixa

---

### C. Módulo Estoque: Objeto Item

O objeto Item possui um comportamento reativo baseado em quantidades (níveis de estoque) e tempo (validade), conforme descrito no UC07 e UC10. Isso se alinha perfeitamente aos eventos temporais (when) descritos nos slides teóricos.

#### Estados Identificados:

- **Disponível**: O item possui saldo suficiente e data de validade segura
- **Estoque Crítico**: A quantidade total caiu abaixo do ponto de reposição, exigindo alerta ao gestor
- **Vencido**: A data de validade foi ultrapassada, exigindo bloqueio de uso e descarte
- **Sem Estoque**: A quantidade total chegou a zero após baixas consecutivas

---

### D. Módulo Estoque: Objeto Pedido

O objeto Pedido gerencia o ciclo de reposição de estoque. Conforme o UC06 e UC07, ele nasce de uma necessidade (alerta de estoque crítico), torna-se uma ordem de compra e passa por um processo de recebimento que pode ser gradual.

#### Estados Identificados:

- **Rascunho (Sugerido)**: O sistema sugere a reposição baseada no estoque crítico, mas o pedido ainda não foi efetivado
- **Aberto (Enviado)**: O pedido foi confirmado e enviado ao fornecedor. Aguarda entrega
- **Recebido Parcialmente**: Parte dos itens chegou e foi processada (UC06), mas ainda há pendências
- **Concluído (Recebido Totalmente)**: Todos os itens foram entregues e o pedido é encerrado

---

### E. Módulo Agendamento: Objeto BlocoAgenda

O BlocoAgenda representa um bloqueio administrativo na agenda do médico (ex: férias, congressos), conforme o UC04. Diferente de um agendamento com paciente, ele é um impedimento de tempo.

#### Estados Identificados:

- **Ativo**: O bloqueio está vigente e impede novos agendamentos no período
- **Concluído**: A data fim do bloqueio já passou (evento temporal)
- **Cancelado**: O médico ou gestor removeu o bloqueio manualmente antes do término

---

## 2. Diagramas de Transição de Estados (DTE)

### DTE 1: Objeto Agendamento

Este diagrama destaca o uso de **Pontos de Junção** para decidir entre um agendamento normal ou um fluxo de exceção (Encaixe), e validações de cancelamento baseadas em regras de negócio.

#### Código PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Agendamento

skinparam state {
  BackgroundColor LightYellow
  BorderColor DarkGreen
  ArrowColor DarkSlateGray
}

state "Solicitado" as Solicitado
state "Agendado" as Agendado : entry / reservarHorario()
state "Pendente Aprovação" as Pendente : entry / notificarMedico()
state "Cancelado" as Cancelado : entry / liberarAgenda()
state "Realizado" as Realizado : entry / registrarProntuario()
state "Cancelado Tarde" as Multa : entry / gerarCobranca()

state c1 <<choice>>
state c2 <<choice>>

[*] --> Solicitado : Iniciar Agendamento

Solicitado --> c1 : verificarDisponibilidade()

' Ponto de Junção: Decide se agenda direto ou pede encaixe
c1 --> Agendado : [horarioLivre == true] / confirmar()
c1 --> Pendente : [horarioLivre == false] / solicitarEncaixe()
c1 --> [*] : [horarioLivre == false e recusaEncaixe] / abortar()

' Transições de Encaixe
Pendente --> Agendado : autorizarEncaixe() [permissao == true] / marcarComoEncaixe()
Pendente --> [*] : rejeitarEncaixe() / notificarRecusa()

' Ciclo de vida normal
Agendado --> Realizado : realizarConsulta() / darBaixa()
Agendado --> c2 : cancelar()

' Regra de Negócio: Cancelamento com antecedência
c2 --> Cancelado : [antecedencia >= 24h] / registrarMotivo()
c2 --> Multa : [antecedencia < 24h] / registrarMotivo()

Realizado --> [*]
Cancelado --> [*]
Multa --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 1 - Agendamento](images/image3.png)

---

### DTE 2: Objeto Item (Estoque)

Este diagrama foca no uso de **eventos de mudança (when)** e **eventos temporais** para controlar a validade e níveis de estoque automaticamente.

#### Código PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Item de Estoque

skinparam state {
  BackgroundColor AliceBlue
  BorderColor Blue
  ArrowColor Navy
}

state "Processando Entrada" as Entrada

state "Disponível" as Disponivel {
  state "Nível Normal" as Normal
  state "Nível Crítico" as Critico : entry / gerarAlertaGestor()
  
  [*] --> Normal
  
  ' Transição automática baseada em condição (Evento de Mudança)
  Normal --> Critico : when(qtdTotal < pontoReposicao)
  Critico --> Normal : reporEstoque() [qtdTotal > pontoReposicao]
}

state "Sem Estoque" as Zerado : entry / bloquearBaixa()
state "Vencido" as Vencido : entry / bloquearUso()

[*] --> Entrada : Receber NF

Entrada --> Disponivel : [validade > 30 dias] / registrarLote()
Entrada --> [*] : [validade <= 30 dias] / devolverFornecedor()

' Baixa de item
Disponivel --> Disponivel : darBaixa(qtd) / atualizarSaldo()

' Monitoramento contínuo
Disponivel --> Zerado : when(qtdTotal == 0)
Zerado --> Disponivel : processarEntrada()

' Monitoramento de Validade
Disponivel --> Vencido : when(dataAtual >= dataValidade)
Vencido --> [*] : descartarItem() / registrarPerda()

@enduml
```

#### Diagrama Gerado

![DTE 2 - Item de Estoque](images/image5.png)

---

### DTE 3: Objeto Paciente

Foca na **validação inicial e unicidade do registro (CPF)**.

#### Código PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Paciente

skinparam state {
  BackgroundColor MistyRose
  BorderColor DarkRed
  ArrowColor Maroon
}

state "Em Cadastro" as Validando : do / preencherDados()
state "Ativo" as Ativo : entry / gerarID()
state "Recusado" as Erro : entry / exibirErroDuplicidade()

state c_cpf <<choice>>

[*] --> Validando : Novo Paciente

Validando --> c_cpf : confirmar()

' Condição de Guarda para CPF Único
c_cpf --> Ativo : [cpfUnico == true] / salvarNoBanco()
c_cpf --> Erro : [cpfUnico == false] / logarTentativa()

Ativo --> Ativo : editarDados()
Ativo --> [*]

Erro --> Validando : corrigirCPF()
Erro --> [*] : cancelar()

@enduml
```

#### Diagrama Gerado

![DTE 3 - Paciente](images/image2.png)

---

### DTE 4: Objeto Pedido

Ilustra o **processo de aquisição** e o **loop de recebimento parcial** até a conclusão total.

#### Código PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Pedido

skinparam state {
  BackgroundColor WhiteSmoke
  BorderColor DimGray
  ArrowColor Black
}

state "Rascunho" as Rascunho : entry / calcularNecessidade()
state "Aberto" as Aberto : entry / enviarParaFornecedor()
state "Recebido Parcialmente" as Parcial : entry / atualizarSaldoEntregue()
state "Concluído" as Concluido : entry / fecharPedido()

state c_recebimento <<choice>>

[*] --> Rascunho : Gerar Sugestão (UC07)

Rascunho --> Aberto : Confirmar Compra

Aberto --> c_recebimento : Processar Entrada NF (UC06)

' Ponto de Junção para verificar completude
c_recebimento --> Parcial : [itensEntregues < itensPedidos]
c_recebimento --> Concluido : [itensEntregues == itensPedidos]

' Do parcial para o concluído ou manter parcial
Parcial --> c_recebimento : Processar Nova NF

Concluido --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 4 - Pedido](images/image1.png)

---

### DTE 5: Objeto BlocoAgenda

Ilustra um **ciclo de vida simples** baseado em tempo ou ação administrativa de cancelamento.

#### Código PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do BlocoAgenda

skinparam state {
  BackgroundColor Lavender
  BorderColor Purple
  ArrowColor Indigo
}

state "Ativo" as Ativo : entry / bloquearHorarios() \n do / rejeitarNovosAgendamentos()
state "Concluido" as Concluido : entry / arquivarHistorico()
state "Cancelado" as Cancelado : entry / liberarHorarios()

[*] --> Ativo : Registrar Bloqueio (UC04)

' Evento Temporal
Ativo --> Concluido: when(dataAtual > dataFim)

' Ação do Usuário
Ativo --> Cancelado : desbloquearManual()

Concluido --> [*]
Cancelado --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 5 - BlocoAgenda](images/image4.png)

---

## Observações sobre os Diagramas

### Conceitos Aplicados

1. **Estados Compostos**: O Item possui um estado "Disponível" que contém dois subestados (Normal e Crítico)
2. **Pontos de Junção (Choice)**: Usados em Agendamento, Paciente e Pedido para decisões baseadas em condições
3. **Eventos Temporais (when)**: Monitoramento automático de validade (Item) e prazos (BlocoAgenda)
4. **Condições de Guarda**: Validações como `[cpfUnico == true]`, `[antecedencia >= 24h]`
5. **Ações de Entrada/Saída**: `entry /`, `do /`, ações em transições `/`

### Rastreabilidade com Casos de Uso

- **DTE Agendamento**: UC02 (Agendar Consulta), UC03 (Solicitar Encaixe), UC09 (Cancelar Agendamento)
- **DTE Item**: UC05 (Dar Baixa), UC06 (Processar Entrada NF), UC07 (Alerta de Estoque Crítico), UC10 (Controlar Validade)
- **DTE Paciente**: UC01 (Cadastrar Novo Paciente)
- **DTE Pedido**: UC06 (Processar Entrada NF), UC07 (Gerar Alerta)
- **DTE BlocoAgenda**: UC04 (Registrar Bloqueio de Agenda)

---

**Versão**: 1.0  
**Última Atualização**: Dezembro de 2025  
**Equipe**: Grupo 4 - SimpleHealth
