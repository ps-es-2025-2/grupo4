# 3.10. Modelagem de Estados

Este documento descreve o comportamento din√¢mico de 5 objetos essenciais do sistema SimpleHealth, cobrindo os m√≥dulos de Cadastro, Agendamento e Estoque atrav√©s de Diagramas de Transi√ß√£o de Estados (DTE).

## Sum√°rio

- [Notas T√©cnicas - Corre√ß√µes de Discrep√¢ncias](#notas-t√©cnicas---corre√ß√µes-de-discrep√¢ncias)
- [1. Descri√ß√£o dos Objetos e Estados](#1-descri√ß√£o-dos-objetos-e-estados)
  - [A. M√≥dulo Cadastro: Objeto Paciente](#a-m√≥dulo-cadastro-objeto-paciente)
  - [B. M√≥dulo Agendamento: Objeto Agendamento](#b-m√≥dulo-agendamento-objeto-agendamento)
  - [C. M√≥dulo Estoque: Objeto Item](#c-m√≥dulo-estoque-objeto-item)
  - [D. M√≥dulo Estoque: Objeto Pedido](#d-m√≥dulo-estoque-objeto-pedido)
  - [E. M√≥dulo Agendamento: Objeto BlocoAgenda](#e-m√≥dulo-agendamento-objeto-blocoagenda)
- [2. Diagramas de Transi√ß√£o de Estados (DTE)](#2-diagramas-de-transi√ß√£o-de-estados-dte)
  - [DTE 1: Objeto Agendamento](#dte-1-objeto-agendamento)
  - [DTE 2: Objeto Item (Estoque)](#dte-2-objeto-item-estoque)
  - [DTE 3: Objeto Paciente](#dte-3-objeto-paciente)
  - [DTE 4: Objeto Pedido](#dte-4-objeto-pedido)
  - [DTE 5: Objeto BlocoAgenda](#dte-5-objeto-blocoagenda)

---

## Notas T√©cnicas - Corre√ß√µes de Discrep√¢ncias

Os diagramas de estados foram atualizados para refletir discrep√¢ncias identificadas.

### Discrep√¢ncia 5.1: UC07 - Impacto no DTE Item e Pedido

**Discrep√¢ncia:** Diagramas mostravam eventos de UC07 (alertas de estoque cr√≠tico), mas UC07 n√£o implementado.

**Mudan√ßa Feita:** DTEs Item e Pedido atualizados com notas de que UC07 n√£o funciona. Eventos when(estoqueAbaixo) existem no diagrama conceitual mas n√£o disparam a√ß√µes.

**Justificativa:** UC07 tem publisher mas nenhum subscriber. Alertas n√£o s√£o gerados.

**Documento Detalhado:** [üìÑ CORRECAO_DISCREPANCIA_5.1.md](../../../Corre√ß√µes%20de%20Alinhamento/CORRECAO_DISCREPANCIA_5.1.md)

---

Para consultar todas as corre√ß√µes, acesse o [üìë Sum√°rio de Corre√ß√µes](../../../Corre√ß√µes%20de%20Alinhamento/SUMARIO_CORRECAO_DISCREPANCIA.md).

---

## 1. Descri√ß√£o dos Objetos e Estados

### A. M√≥dulo Cadastro: Objeto Paciente

Embora o diagrama de classes mostre o Paciente como uma entidade de dados est√°tica, o Caso de Uso UC01 (Cadastrar Novo Paciente) define um fluxo de valida√ß√£o rigoroso. O objeto passa por um est√°gio transit√≥rio de valida√ß√£o antes de se tornar persistente no sistema.

#### Estados Identificados:

- **Em Valida√ß√£o**: O sistema verifica a formata√ß√£o e unicidade do CPF
- **Ativo**: O paciente foi validado, gravado e est√° apto para agendamentos
- **Recusado/Erro**: O CPF j√° existe ou √© inv√°lido, impedindo a persist√™ncia

---

### B. M√≥dulo Agendamento: Objeto Agendamento

Este √© o objeto com o ciclo de vida mais complexo, envolvendo intera√ß√µes entre Paciente, M√©dico e Gestor. As transi√ß√µes dependem de disponibilidade, permiss√µes (encaixe) e execu√ß√£o do servi√ßo, conforme UC02, UC03 e UC09.

#### Estados Identificados:

- **Solicitado**: Estado inicial onde se verifica a disponibilidade na agenda
- **Agendado (Confirmado)**: O hor√°rio foi reservado com sucesso e o status na agenda do m√©dico √© "Ocupado"
- **Pendente de Aprova√ß√£o (Encaixe)**: Ocorre quando h√° conflito de agenda, mas o usu√°rio solicita um "Encaixe" (UC03), dependendo de permiss√£o
- **Cancelado**: O agendamento foi revogado antes da execu√ß√£o. Pode ocorrer dentro ou fora do prazo (gerando penalidade/multa)
- **Realizado**: A consulta ocorreu e o sistema deu baixa

---

### C. M√≥dulo Estoque: Objeto Item

O objeto Item possui um comportamento reativo baseado em quantidades (n√≠veis de estoque) e tempo (validade), conforme descrito no UC07 e UC10. Isso se alinha perfeitamente aos eventos temporais (when) descritos nos slides te√≥ricos.

#### Estados Identificados:

- **Dispon√≠vel**: O item possui saldo suficiente e data de validade segura
- **Estoque Cr√≠tico**: A quantidade total caiu abaixo do ponto de reposi√ß√£o, exigindo alerta ao gestor
- **Vencido**: A data de validade foi ultrapassada, exigindo bloqueio de uso e descarte
- **Sem Estoque**: A quantidade total chegou a zero ap√≥s baixas consecutivas

---

### D. M√≥dulo Estoque: Objeto Pedido

O objeto Pedido gerencia o ciclo de reposi√ß√£o de estoque. Conforme o UC06 e UC07, ele nasce de uma necessidade (alerta de estoque cr√≠tico), torna-se uma ordem de compra e passa por um processo de recebimento que pode ser gradual.

#### Estados Identificados:

- **Rascunho (Sugerido)**: O sistema sugere a reposi√ß√£o baseada no estoque cr√≠tico, mas o pedido ainda n√£o foi efetivado
- **Aberto (Enviado)**: O pedido foi confirmado e enviado ao fornecedor. Aguarda entrega
- **Recebido Parcialmente**: Parte dos itens chegou e foi processada (UC06), mas ainda h√° pend√™ncias
- **Conclu√≠do (Recebido Totalmente)**: Todos os itens foram entregues e o pedido √© encerrado

---

### E. M√≥dulo Agendamento: Objeto BlocoAgenda

O BlocoAgenda representa um bloqueio administrativo na agenda do m√©dico (ex: f√©rias, congressos), conforme o UC04. Diferente de um agendamento com paciente, ele √© um impedimento de tempo.

#### Estados Identificados:

- **Ativo**: O bloqueio est√° vigente e impede novos agendamentos no per√≠odo
- **Conclu√≠do**: A data fim do bloqueio j√° passou (evento temporal)
- **Cancelado**: O m√©dico ou gestor removeu o bloqueio manualmente antes do t√©rmino

---

## 2. Diagramas de Transi√ß√£o de Estados (DTE)

### DTE 1: Objeto Agendamento

Este diagrama destaca o uso de **Pontos de Jun√ß√£o** para decidir entre um agendamento normal ou um fluxo de exce√ß√£o (Encaixe), e valida√ß√µes de cancelamento baseadas em regras de neg√≥cio.

#### C√≥digo PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Agendamento

skinparam state {
  BackgroundColor LightYellow
  BorderColor DarkGreen
  ArrowColor DarkSlateGray
}

state "Solicitado" as Solicitado
state "Agendado" as Agendado : entry / reservarHorario()
state "Pendente Aprova√ß√£o" as Pendente : entry / notificarMedico()
state "Cancelado" as Cancelado : entry / liberarAgenda()
state "Realizado" as Realizado : entry / registrarProntuario()
state "Cancelado Tarde" as Multa : entry / gerarCobranca()

state c1 <<choice>>
state c2 <<choice>>

[*] --> Solicitado : Iniciar Agendamento

Solicitado --> c1 : verificarDisponibilidade()

' Ponto de Jun√ß√£o: Decide se agenda direto ou pede encaixe
c1 --> Agendado : [horarioLivre == true] / confirmar()
c1 --> Pendente : [horarioLivre == false] / solicitarEncaixe()
c1 --> [*] : [horarioLivre == false e recusaEncaixe] / abortar()

' Transi√ß√µes de Encaixe
Pendente --> Agendado : autorizarEncaixe() [permissao == true] / marcarComoEncaixe()
Pendente --> [*] : rejeitarEncaixe() / notificarRecusa()

' Ciclo de vida normal
Agendado --> Realizado : realizarConsulta() / darBaixa()
Agendado --> c2 : cancelar()

' Regra de Neg√≥cio: Cancelamento com anteced√™ncia
c2 --> Cancelado : [antecedencia >= 24h] / registrarMotivo()
c2 --> Multa : [antecedencia < 24h] / registrarMotivo()

Realizado --> [*]
Cancelado --> [*]
Multa --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 1 - Agendamento](images/image3.png)

---

### DTE 2: Objeto Item (Estoque)

Este diagrama foca no uso de **eventos de mudan√ßa (when)** e **eventos temporais** para controlar a validade e n√≠veis de estoque automaticamente.

#### C√≥digo PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Item de Estoque

skinparam state {
  BackgroundColor AliceBlue
  BorderColor Blue
  ArrowColor Navy
}

state "Processando Entrada" as Entrada

state "Dispon√≠vel" as Disponivel {
  state "N√≠vel Normal" as Normal
  state "N√≠vel Cr√≠tico" as Critico : entry / gerarAlertaGestor()
  
  [*] --> Normal
  
  ' Transi√ß√£o autom√°tica baseada em condi√ß√£o (Evento de Mudan√ßa)
  Normal --> Critico : when(qtdTotal < pontoReposicao)
  Critico --> Normal : reporEstoque() [qtdTotal > pontoReposicao]
}

state "Sem Estoque" as Zerado : entry / bloquearBaixa()
state "Vencido" as Vencido : entry / bloquearUso()

[*] --> Entrada : Receber NF

Entrada --> Disponivel : [validade > 30 dias] / registrarLote()
Entrada --> [*] : [validade <= 30 dias] / devolverFornecedor()

' Baixa de item
Disponivel --> Disponivel : darBaixa(qtd) / atualizarSaldo()

' Monitoramento cont√≠nuo
Disponivel --> Zerado : when(qtdTotal == 0)
Zerado --> Disponivel : processarEntrada()

' Monitoramento de Validade
Disponivel --> Vencido : when(dataAtual >= dataValidade)
Vencido --> [*] : descartarItem() / registrarPerda()

@enduml
```

#### Diagrama Gerado

![DTE 2 - Item de Estoque](images/image5.png)

---

### DTE 3: Objeto Paciente

Foca na **valida√ß√£o inicial e unicidade do registro (CPF)**.

#### C√≥digo PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Paciente

skinparam state {
  BackgroundColor MistyRose
  BorderColor DarkRed
  ArrowColor Maroon
}

state "Em Cadastro" as Validando : do / preencherDados()
state "Ativo" as Ativo : entry / gerarID()
state "Recusado" as Erro : entry / exibirErroDuplicidade()

state c_cpf <<choice>>

[*] --> Validando : Novo Paciente

Validando --> c_cpf : confirmar()

' Condi√ß√£o de Guarda para CPF √önico
c_cpf --> Ativo : [cpfUnico == true] / salvarNoBanco()
c_cpf --> Erro : [cpfUnico == false] / logarTentativa()

Ativo --> Ativo : editarDados()
Ativo --> [*]

Erro --> Validando : corrigirCPF()
Erro --> [*] : cancelar()

@enduml
```

#### Diagrama Gerado

![DTE 3 - Paciente](images/image2.png)

---

### DTE 4: Objeto Pedido

Ilustra o **processo de aquisi√ß√£o** e o **loop de recebimento parcial** at√© a conclus√£o total.

#### C√≥digo PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do Pedido

skinparam state {
  BackgroundColor WhiteSmoke
  BorderColor DimGray
  ArrowColor Black
}

state "Rascunho" as Rascunho : entry / calcularNecessidade()
state "Aberto" as Aberto : entry / enviarParaFornecedor()
state "Recebido Parcialmente" as Parcial : entry / atualizarSaldoEntregue()
state "Conclu√≠do" as Concluido : entry / fecharPedido()

state c_recebimento <<choice>>

[*] --> Rascunho : Gerar Sugest√£o (UC07)

Rascunho --> Aberto : Confirmar Compra

Aberto --> c_recebimento : Processar Entrada NF (UC06)

' Ponto de Jun√ß√£o para verificar completude
c_recebimento --> Parcial : [itensEntregues < itensPedidos]
c_recebimento --> Concluido : [itensEntregues == itensPedidos]

' Do parcial para o conclu√≠do ou manter parcial
Parcial --> c_recebimento : Processar Nova NF

Concluido --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 4 - Pedido](images/image1.png)

---

### DTE 5: Objeto BlocoAgenda

Ilustra um **ciclo de vida simples** baseado em tempo ou a√ß√£o administrativa de cancelamento.

#### C√≥digo PlantUML

```plantuml
@startuml

title DTE - Ciclo de Vida do BlocoAgenda

skinparam state {
  BackgroundColor Lavender
  BorderColor Purple
  ArrowColor Indigo
}

state "Ativo" as Ativo : entry / bloquearHorarios() \n do / rejeitarNovosAgendamentos()
state "Concluido" as Concluido : entry / arquivarHistorico()
state "Cancelado" as Cancelado : entry / liberarHorarios()

[*] --> Ativo : Registrar Bloqueio (UC04)

' Evento Temporal
Ativo --> Concluido: when(dataAtual > dataFim)

' A√ß√£o do Usu√°rio
Ativo --> Cancelado : desbloquearManual()

Concluido --> [*]
Cancelado --> [*]

@enduml
```

#### Diagrama Gerado

![DTE 5 - BlocoAgenda](images/image4.png)

---

## Observa√ß√µes sobre os Diagramas

### Conceitos Aplicados

1. **Estados Compostos**: O Item possui um estado "Dispon√≠vel" que cont√©m dois subestados (Normal e Cr√≠tico)
2. **Pontos de Jun√ß√£o (Choice)**: Usados em Agendamento, Paciente e Pedido para decis√µes baseadas em condi√ß√µes
3. **Eventos Temporais (when)**: Monitoramento autom√°tico de validade (Item) e prazos (BlocoAgenda)
4. **Condi√ß√µes de Guarda**: Valida√ß√µes como `[cpfUnico == true]`, `[antecedencia >= 24h]`
5. **A√ß√µes de Entrada/Sa√≠da**: `entry /`, `do /`, a√ß√µes em transi√ß√µes `/`

### Rastreabilidade com Casos de Uso

- **DTE Agendamento**: UC02 (Agendar Consulta), UC03 (Solicitar Encaixe), UC09 (Cancelar Agendamento)
- **DTE Item**: UC05 (Dar Baixa), UC06 (Processar Entrada NF), UC07 (Alerta de Estoque Cr√≠tico - N√ÉO IMPLEMENTADO), UC10 (Controlar Validade)
- **DTE Paciente**: UC01 (Cadastrar Novo Paciente)
- **DTE Pedido**: UC06 (Processar Entrada NF), UC07 (Gerar Alerta - N√ÉO IMPLEMENTADO)
- **DTE BlocoAgenda**: UC04 (Registrar Bloqueio de Agenda)

---

**Vers√£o**: 1.0  
**√öltima Atualiza√ß√£o**: Dezembro de 2025  
**Equipe**: Grupo 4 - SimpleHealth
